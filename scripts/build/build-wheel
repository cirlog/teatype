#!/usr/bin/env python3.11

# Copyright (C) 2024-2026 Burak GÃ¼naydin
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.

# Standard-library imports
import os
import shutil
import subprocess
from pathlib import Path
from packaging import version

PACKAGE_NAME = 'teatype'
PARENT_PATH = Path(__file__).parent.parent.parent
PACKAGE_PATH = PARENT_PATH / 'py'
FILES_PATH = PARENT_PATH / 'files' / 'build' / 'py'
WHEEL_DIR = PARENT_PATH / 'build' / 'wheel'
VERSION_FILE = FILES_PATH / 'version.txt'
HISTORY_FILE = FILES_PATH / 'version_history.txt'

def get_pypi_versions():
    try:
        result = subprocess.run(
            ['python3.11', '-m', 'pip', 'index', 'versions', PACKAGE_NAME],
            capture_output=True,
            text=True,
            check=True,
        )
    except Exception:
        return set()

    lines = result.stdout.splitlines()
    versions = set()
    for line in lines:
        if "Available versions:" in line:
            # crude parse: "Available versions: 2025.1.0.3, 2025.1.0.2, ..."
            part = line.split("Available versions:")[-1]
            for v in part.split(","):
                v = v.strip()
                if v:
                    versions.add(v)
    return versions

def load_local_history():
    versions = set()
    if HISTORY_FILE.exists():
        for line in HISTORY_FILE.read_text().splitlines():
            v = line.strip()
            if v:
                versions.add(v)
    if VERSION_FILE.exists():
        versions.add(VERSION_FILE.read_text().strip())
    return versions

def main():
    current_dir = os.getcwd()
    
    try:
        os.chdir(PACKAGE_PATH)
        
        existing_local = load_local_history()
        existing_remote = get_pypi_versions()
        forbidden = existing_local | existing_remote

        print(f'Known versions: {sorted(forbidden)}')
        desired = input('Enter new version: ').strip()

        if desired in forbidden:
            raise SystemExit(f'ERROR: version {desired} already exists. Pick another.')

        # Check if new version is lower than any existing version
        try:
            desired_ver = version.parse(desired)
            for existing in forbidden:
                try:
                    if desired_ver < version.parse(existing):
                        raise SystemExit(f'ERROR: version {desired} is lower than existing version {existing}. Use a higher version.')
                except Exception:
                    pass  # Skip invalid version formats
        except ImportError:
            # Fallback: simple string comparison if packaging is not available
            if forbidden and desired < max(forbidden):
                raise SystemExit(f'ERROR: version {desired} appears to be lower than existing versions. Use a higher version.')

        subprocess.run(['python3.11', '-m', 'build', '--wheel', '--outdir', WHEEL_DIR], check=True, capture_output=False, text=True)        

        VERSION_FILE.write_text(desired + '\n')
        with HISTORY_FILE.open('a', encoding='utf-8') as f:
            f.write(desired + '\n')
            
        shutil.rmtree('build')
    except:
        import traceback
        traceback.print_exc()
    finally:
        os.chdir(current_dir)

if __name__ == '__main__':
    main()