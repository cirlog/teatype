#!/bin/bash

# Copyright (C) 2024-2026 Burak GÃ¼naydin
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.

set -e  # Exit on error
set -u  # Exit on undefined variable

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Configuration
NODE_VERSION="20"
PNPM_VERSION="10.12.1"
NVM_VERSION="v0.40.1"

log_info "Starting Node.js and pnpm installation..."

# Update package list
log_info "Updating package list..."
sudo apt update -y

# Remove old Node.js installations
if command -v node &> /dev/null || command -v nodejs &> /dev/null; then
    log_warn "Removing old Node.js installations..."
    sudo apt-get remove -y node nodejs npm 2>/dev/null || true
    sudo apt-get autoremove -y
fi

# Install nginx (if needed for your setup)
if ! command -v nginx &> /dev/null; then
    log_info "Installing nginx..."
    sudo apt-get install -y nginx
    sudo systemctl disable nginx
    log_info "Nginx installed and disabled"
fi

# Setup NVM
export NVM_DIR="$HOME/.nvm"

if [ -d "$NVM_DIR" ]; then
    log_warn "NVM already installed, updating..."
    cd "$NVM_DIR"
    git fetch --tags origin
    git checkout $NVM_VERSION 2>/dev/null || log_warn "Could not checkout $NVM_VERSION, using existing version"
    cd -
else
    log_info "Installing NVM..."
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/$NVM_VERSION/install.sh | bash
fi

# Load NVM
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

# Verify NVM loaded
if ! command -v nvm &> /dev/null; then
    log_error "NVM installation failed"
    exit 1
fi

log_info "NVM installed successfully: $(nvm --version)"

# Install and use Node.js
log_info "Installing Node.js $NODE_VERSION..."
nvm install $NODE_VERSION
nvm use $NODE_VERSION
nvm alias default $NODE_VERSION

# Verify Node.js installation
if ! command -v node &> /dev/null; then
    log_error "Node.js installation failed"
    exit 1
fi

log_info "Node.js installed: $(node --version)"
log_info "npm installed: $(npm --version)"

# Setup corepack for pnpm
log_info "Setting up corepack..."
export COREPACK_ENABLE_DOWNLOAD_PROMPT=0

# Enable corepack (comes with Node 16.9+)
corepack enable

# Clean corepack cache
rm -rf ~/.cache/corepack 2>/dev/null || true

# Prepare pnpm
log_info "Installing pnpm $PNPM_VERSION..."
corepack prepare pnpm@$PNPM_VERSION --activate

# Verify pnpm installation
if ! command -v pnpm &> /dev/null; then
    log_error "pnpm installation failed"
    exit 1
fi

log_info "pnpm installed: $(pnpm --version)"

# Add to .bashrc if not already present
if ! grep -q "NVM_DIR" ~/.bashrc; then
    log_info "Adding NVM to ~/.bashrc..."
    cat >> ~/.bashrc << 'EOF'

# NVM Configuration
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

# Corepack Configuration
export COREPACK_ENABLE_DOWNLOAD_PROMPT=0
EOF
fi

log_info "Installation complete!"
log_info "Node.js version: $(node --version)"
log_info "npm version: $(npm --version)"
log_info "pnpm version: $(pnpm --version)"
log_info ""
log_warn "Please restart your terminal or run: source ~/.bashrc"